---
title: "Biking Patterns in Boston"
author: "Mette Hejberg Pedersen"
date: "4/26/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading packages
```{r}
library(tidyverse)
#library(readr)
library(leaflet)
#library(mapboxapi)
#library(htmlwidgets)
#library(osmdata)
library(sf)
#library(ggmap)
#library(magrittr)
#library(spatstat)
library(sp)
library(htmlwidgets)
library(webshot)
library(maps)
```

# Loading 2019 data
```{r data}
file_name <- "data/bluebikes_tripdata_2019.csv"
# read:
data_2019 <- read_csv(file_name, progress = FALSE)

data_2019 <- data_2019 %>% rename("start_long" = "start station longitude",
                                      "start_lat" = "start station latitude",
                                      "end_long" = "end station longitude",
                                      "end_lat" = "end station latitude",
                                      "start_station_id" = "start station id",
                                      "start_station_name" = "start station name",
                                      "end_station_name" = "end station name",
                                      "birth_year" = "birth year")
```

# Basic data explorations
Exploring basic patterns in the data that might be interesting for further exploration
```{r}
# subscribers vs. customers (single use)
data_2019 %>% filter(usertype == "Subscriber") %>% count() # returns 1988494
data_2019 %>% filter(usertype == "Customer") %>% count() # returns 534277

# genders 
data_2019 %>% filter(gender == 0) %>% count() # 277703 (female?)
data_2019 %>% filter(gender == 1) %>% count() # 1652699 (male?)
data_2019 %>% filter(gender == 2) %>% count() # 592369 (other?)

# age range
data_2019 %>% select(birth_year) %>% range() # return 1886 2003
data_2019 %>% filter(birth_year == 1886) %>% count() # returns 3

# trip duration range
data_2019 %>% select(tripduration) %>% range() # 61 42567137
```

There are many more subscribers which suggests that it's mostly locals using the bikes. 

Maybe it's just me but it seems like there's something off about the gender data, so I might not include that. 

There is also something weird about the age data - there are three entries of 1888 and just in general quite old people so again, I might not use this information. 

There is also a massive range in trip duration but that's not necessarily an error 

On the basis of this exploration I select the columns I want to use to reduce the strain on my computer when working with such large files

# Cleaning the data prior to analysis
```{r}
cleaned_2019 <- data_2019 %>% select(c(tripduration, starttime, stoptime, start_lat, start_long, start_station_name, end_lat, end_long, end_station_name, usertype, year, month))

cleaned_2019
```

Let's make a map and plot the end and start stations as points. Let's start by plotting each start station. I only want one entry pr. start station, so I need to find the unique stations
```{r}
unique_start <- cleaned_2019 %>% select(c(start_long, start_lat, start_station_name)) %>% unique()
# there was a single outlier, so I remove it
unique_start <- unique_start[!(unique_start$start_long == 0.0000|unique_start$start_lat == 0.0000), ]

# other outliers
unique_start <- unique_start %>% filter(start_station_name != "BCBS Hingham")
unique_start <- unique_start %>% filter(start_station_name != "Main St at Beacon St")
```

I do the same for the end stations
```{r}
unique_end <- cleaned_2019 %>% select(c(end_long, end_lat, end_station_name)) %>% unique()
# I do the same for the end stations
unique_end <- unique_end[!(unique_end$end_long == 0.0000|unique_end$end_lat == 0.000), ]
# another outlier
unique_end <- unique_end %>% filter(end_station_name != "BCBS Hingham")
```

# Spatial analysis 
## Basic maps 
Make two quick maps
```{r}
m1 <- leaflet() %>% addTiles() %>%
  setView(lng = -71.057083, lat = 42.361145, zoom = 12) %>% 
  addCircleMarkers(lng = unique_start$start_long, lat = unique_start$start_lat)
m1
```

```{r}
m2 <- leaflet(unique_end) %>% addTiles() %>% setView(lng = -71.057083, lat = 42.361145, zoom = 12) %>% addCircleMarkers(lng = unique_end$end_long, lat = unique_end$end_lat)
m2
#saveWidget(m2, "out/2019_end_stations.html", selfcontained = FALSE)
```
The two maps look almost identical.

## Figuring out where people are going 
load Boston city boundary and neighborhoods
```{r}
# neighborhoods
neighborhoods <- st_read("data/Boston_Neighborhoods/Boston_Neighborhoods.shp")
# reproject to get it on the map
projected_neighborhoods <- st_transform(neighborhoods, 4326)
```

Plot the neighborhoods and stations together 
start stations and neighborhoods
```{r}
p_popup <- paste0("<strong>Neighborhood: </strong>", projected_neighborhoods$Name) 

p2_popup <- paste0("<strong>Start station: </strong>", unique_start$start_station_name)

leaflet(projected_neighborhoods) %>% 
  addPolygons(
    stroke = TRUE, 
    fillColor = "yellow", 
    fillOpacity = 0.8, smoothFactor = 0.5, # to make it look nicer
    popup = p_popup) %>% # add popup 
  addTiles() %>%
  setView(lng = -71.057083, lat = 42.361145, zoom = 11.5) %>% 
  addCircleMarkers(lng = unique_start$start_long,
                   lat = unique_start$start_lat,
                   popup = p2_popup)
```
end stations and neighborhoods
```{r}
p_popup <- paste0("<strong>Neighborhood: </strong>", projected_neighborhoods$Name) 

p3_popup <- paste0("<strong>End station: </strong>", unique_end$end_station_name)

leaflet(projected_neighborhoods) %>% 
  addPolygons(
    stroke = TRUE, 
    fillColor = "yellow", 
    fillOpacity = 0.8, smoothFactor = 0.5, # to make it look nicer
    popup = p_popup) %>% # add popup 
  addTiles() %>%
  setView(lng = -71.057083, lat = 42.361145, zoom = 11.5) %>% 
  addCircleMarkers(lng = unique_end$end_long,
                   lat = unique_end$end_lat,
                   popup = p2_popup)
```

From these maps, we can get an idea of where in Boston are moving, both within the larger city boundary and within neighbors of the city. Now I want to use st_intersect or something on the neighborhoods and the points to find the most popular areas. 

One thing to consider in the analysis of the most popular areas is that there are very small neighborhoods in central Boston and very large neighborhoods on the outskirts of the city. It is therefore difficult for a small neighborhood to have the same amount of bike stations as larger neighborhoods. However, on the other hand, from just looking at the maps, the central parts of the city are clearly the most popular, so perhaps this is not an issue.

To get the intersections of the points and the neighborhoods, I create a convex hull around the points. First I transform the longitude and latitude coordinates into a sf object.
```{r}
# remove NAs if there is any
points <- unique_start %>% 
  filter(! is.na(start_long)) %>% 
  filter(! is.na(start_lat))

# transform points to sf object
points_sf <- st_as_sf(points, coords = c("start_long", "start_lat"), crs = 4326)
points_sf
# transform its crs 
points_3035 <- st_transform(points_sf, crs = 3035)
points_3035
# create convex hull
points_ch <- st_convex_hull(st_union(points_3035))
points_ch

plot(points_ch)
class(points_ch)
```

I have now created a polygon out of the start station points.

Let's get the intersection between this polygon and the neighborhoods multipolygon
```{r}
# make sure they have the same crs
neighborhoods_3035 <- st_transform(neighborhoods, crs = 3035)

# get the intersections
points_neighborhoods_intersection <- st_intersection(points_ch, st_geometry(neighborhoods_3035))

# create buffer feature of the neighborhoods
p_n_buff <- st_union(points_neighborhoods_intersection)
```

Plot the objects together
```{r}
plot(points_ch)
plot(points_neighborhoods_intersection, border='red', lwd=2, add = TRUE)
plot(p_n_buff, add = TRUE)
```

The plot shows that the neighborhoods occupy a significant amount of space within the points polygon. However, there is also a large area that the neighborhoods do not cover. Let's look at the map of the start stations and neighborhoods again to compare
```{r}
p_popup <- paste0("<strong>Neighborhood: </strong>", projected_neighborhoods$Name) 

p2_popup <- paste0("<strong>Start station: </strong>", unique_start$start_station_name)

leaflet(projected_neighborhoods) %>% 
  addPolygons(
    stroke = TRUE, 
    fillColor = "yellow", 
    fillOpacity = 0.8, smoothFactor = 0.5, # to make it look nicer
    popup = p_popup) %>% # add popup 
  addTiles() %>%
  setView(lng = -71.057083, lat = 42.361145, zoom = 11.5) %>% 
  addCircleMarkers(lng = unique_start$start_long,
                   lat = unique_start$start_lat,
                   popup = p2_popup)
```

Looking at the map, we can confirm that towards the northern part of the city, the points occupy a space outside the neighborhoods. Furthermore, recall the points polygon that went down into a point, which is due to the single point located far outside the city to the south. 

I do the same for the end stations to see if we find the same patterns.
```{r}
# remove NAs if there is any
points_end <- unique_end %>% 
  filter(! is.na(end_long)) %>% 
  filter(! is.na(end_lat))
# transform the points into an sf object 
points_end_sf <- st_as_sf(points_end, coords = c("end_long", "end_lat"), crs = 4326)
# transform their crs
points_end_3035 <- st_transform(points_end_sf, crs = 3035)
# create convex hull
points_end_ch <- st_convex_hull(st_union(points_end_3035))

# plot it
plot(points_end_ch)
class(points_end_ch)
```

The polygon looks very much identical to the start stations polyogon

Let's get the intersection
```{r}
# get the intersections
points_neighborhoods_intersection_end <- st_intersection(points_end_ch, st_geometry(neighborhoods_3035))

# create buffer feature of the neighborhoods
p_n_buff_end <- st_union(points_neighborhoods_intersection_end)
```

Plot the objects together
```{r}
plot(points_end_ch)
plot(points_neighborhoods_intersection_end, border='red', lwd=2, add = TRUE)
plot(p_n_buff_end, add = TRUE)
```

It looks very much the same for the end stations. Let's look at the map of the end stations and the neighborhoods to compare
```{r}
p_popup <- paste0("<strong>Neighborhood: </strong>", projected_neighborhoods$Name) 

p3_popup <- paste0("<strong>End station: </strong>", unique_end$end_station_name)

leaflet(projected_neighborhoods) %>% 
  addPolygons(
    stroke = TRUE, 
    fillColor = "yellow", 
    fillOpacity = 0.8, smoothFactor = 0.5, # to make it look nicer
    popup = p_popup) %>% # add popup 
  addTiles() %>%
  setView(lng = -71.057083, lat = 42.361145, zoom = 11.5) %>% 
  addCircleMarkers(lng = unique_end$end_long,
                   lat = unique_end$end_lat,
                   popup = p2_popup)
```

Once again, the map confirms what we saw in the plot. There is an area beyond the city boundary towards the north where there are a lot of points, and there is a single point towards the south far outside the city, which gives the polygon its point. 

From now on, when I just want to plot the stations, I just plot the start stations because the end stations are very similar.          

# Loading the 2020 data
Let's look at the 2020 data
```{r}
file_name <- "data/bluebikes_tripdata_2020.csv"
# read:
data_2020 <- read_csv(file_name, progress = FALSE)

data_2020 <- data_2020 %>% rename("start_long" = "start station longitude",
                                      "start_lat" = "start station latitude",
                                      "end_long" = "end station longitude",
                                      "end_lat" = "end station latitude",
                                      "start_station_id" = "start station id",
                                      "start_station_name" = "start station name",
                                      "end_station_name" = "end station name",
                                      "birth_year" = "birth year")
```

# Basic data explorations
Let's do the same initial exploration of the data so see what we're working with
```{r}
# subscribers vs. customers (single use)
data_2020 %>% filter(usertype == "Subscriber") %>% count() # returns 1440363
data_2020 %>% filter(usertype == "Customer") %>% count() # returns 559083
# much fewer subscribers much around the same single use 

# genders 
data_2020 %>% filter(gender == 0) %>% count() # 29691 (female?)
data_2020 %>% filter(gender == 1) %>% count() # 291321 (male?)
data_2020 %>% filter(gender == 2) %>% count() # 94964 (other?)
# much more uniform data here

data_2020 %>% select(birth_year) %>% range() # there is no birth year information

# trip duration range
data_2020 %>% select(tripduration) %>% range() # 61 3879352

# there is also fewer rows in the 2020 dataset
```

# Clearning the data prior to analysis
Let's clean the 2020 data
```{r}
cleaned_2020 <- data_2020 %>% select(c(tripduration, starttime, stoptime, start_lat, start_long, start_station_name, end_lat, end_long, end_station_name, usertype, year, month))

cleaned_2020
```

# Spatial Analysis 
## Figuring out where people are going and comparison with the 2019 data
I'll only look at the start stations
```{r}
unique_start_2020 <- cleaned_2020 %>% select(c(start_long, start_lat, start_station_name)) %>% unique()
# there was a single outlier, so I remove it
unique_start_2020 <- unique_start_2020[!(unique_start_2020$start_long == 0.0000|unique_start_2020$start_lat == 0.0000), ]

# another outlier
unique_start_2020 <- unique_start_2020 %>% filter(start_station_name != "BCBS Hingham")
```

Let's plot the start stations with the neighborhoods
```{r}
# plot the 2020 start stations
p_popup <- paste0("<strong>Neighborhood: </strong>", projected_neighborhoods$Name) 

p5_popup <- paste0("<strong>Start station: </strong>", unique_start_2020$start_station_name)

leaflet(projected_neighborhoods) %>% 
  addPolygons(
    stroke = TRUE, 
    fillColor = "yellow", 
    fillOpacity = 0.8, smoothFactor = 0.5, # to make it look nicer
    popup = p_popup) %>% # add popup 
  addTiles() %>%
  setView(lng = -71.057083, lat = 42.361145, zoom = 11.5) %>% 
  addCircleMarkers(lng = unique_start_2020$start_long,
                   lat = unique_start_2020$start_lat,
                   popup = p5_popup)
```

let's look at the 2019 data for comparison
```{r}
p2_popup <- paste0("<strong>Start station: </strong>", unique_start$start_station_name)

leaflet(projected_neighborhoods) %>% 
  addPolygons(
    stroke = TRUE, 
    fillColor = "yellow", 
    fillOpacity = 0.8, smoothFactor = 0.5, # to make it look nicer
    popup = p_popup) %>% # add popup 
  addTiles() %>%
  setView(lng = -71.057083, lat = 42.361145, zoom = 11.5) %>% 
  addCircleMarkers(lng = unique_start$start_long,
                   lat = unique_start$start_lat,
                   popup = p2_popup)
```

We can see from the maps that there are areas/stations that aren't in the 2019 data which are also outside of the city boundary. These are stations towards the west of the city boundary, beyond Brighton. 

Let's look at the intersection between the points and neighborhoods in 2020
```{r}
# remove NAs if there is any
points_2020 <- unique_start_2020 %>% 
  filter(! is.na(start_long)) %>% 
  filter(! is.na(start_lat))
# transform the points into an sf object 
points_2020_sf <- st_as_sf(points_2020, coords = c("start_long", "start_lat"), crs = 4326)
# transform their crs
points_2020_3035 <- st_transform(points_2020_sf, crs = 3035)
# create convex hull
points_2020_ch <- st_convex_hull(st_union(points_2020_3035))

# plot it
plot(points_2020_ch)
class(points_end_ch)
```

```{r}
# get the intersections
points_neighborhoods_intersection_2020 <- st_intersection(points_2020_ch, st_geometry(neighborhoods_3035))

# create buffer feature of the neighborhoods
p_n_buff_2020 <- st_union(points_neighborhoods_intersection_2020)
```

Plot the objects together
```{r}
plot(points_2020_ch)
plot(points_neighborhoods_intersection_2020, border='red', lwd=2, add = TRUE)
plot(p_n_buff_2020, add = TRUE)
```


```{r}
unique_start %>% select(start_station_name) %>% unique() %>%  count() # 361
unique_start_2020 %>% select(start_station_name) %>% unique() %>% count() # 385 
```

The code above shows that there are around the same unique start station names, with 2020 having 24 more unique start stations. On the one hand, it is surprising that there is a wider range of start stations in 2020, since most people in the world lived in highly restricted way due to Covid-19. However, at least in Denmark, this also led to people going outside with more intention, since the walk or bike ride to work was not a part of our daily lives anymore, and this pattern could perhaps also reflect a similar tendency.

Let's find the most used start station in 2019 and 2020
```{r}
# got the function from here: https://stackoverflow.com/questions/66787325/how-to-find-the-least-frequent-value-in-a-column-of-dataframe-in-r

Modemin <- function(x){
  a = table(x) # x is a column
  return(a[which.min(a)])
}
# least used start station in 2020: MTL-ECO4-01 (1 time)
Modemin(data_2020$start_station_name)
# least used start station in 2019: 8D QC Station 01 (1 time)
Modemin(data_2019$start_station_name)
# lest used end station in 2020: Mobile Temporary Station 1 (1 time)
Modemin(data_2020$end_station_name)
# lest used end station in 2019: 8D QC Station 02 (1 time)
Modemin(data_2019$end_station_name)

Modemax <- function(x){
  a = table(x) # x is a column
  return(a[which.max(a)])
}
# most used start station in 2019: MIT at Mass Ave / Amherst St (61056 times)
Modemax(data_2019$start_station_name)
# most used start station in 2020: Central Square at Mass Ave / Essex St (32668 times )
Modemax(data_2020$start_station_name)
# most used end station in 2019: MIT at Mass Ave / Amherst St (56986 times)
Modemax(data_2019$end_station_name)
# most used end station in 2020: Central Square at Mass Ave / Essex St (33493 times)
Modemax(data_2020$end_station_name)
```

So the most used stations in 2020 are used significantly less than the most used station in 2019. Interstingly, the most used start and end stations in 2019 is the same and the most used start and end station in 2020 is also the same. 

Let's find out where these stations are and plot them with leaflet
```{r}
# most used station in 2019
data_2019 %>% filter(start_station_name == "MIT at Mass Ave / Amherst St") %>% select(c(start_long, start_lat))
leaflet(projected_neighborhoods) %>% addTiles() %>% setView(lng = -71.1, lat = 42.4, zoom = 12) %>% addCircleMarkers(lng = -71.1, lat = 42.4) %>% 
  addPolygons(stroke = TRUE, 
    fillColor = "yellow", 
    fillOpacity = 0.8, smoothFactor = 0.5, # to make it look nicer
    popup = p_popup)

# most used station in 2020
data_2020 %>% filter(start_station_name == "Central Square at Mass Ave / Essex St") %>% select(c(start_long, start_lat))
```

As it turn out the two stations have the same longitude and latitude coordinates. Interestingly, the most used station is far outside the city boundary. From the station name in the 2019 data, it seems that this might be a station close to MIT, so let's find MIT's coordinates and plot it along side the point. 

```{r}
p_popup = paste0("<strong>Start station: </strong>", "MIT")
p_popup2 = paste0("<strong>institution: </strong>", "Central Square at Mass Ave / Essex St")

leaflet(projected_neighborhoods) %>% addTiles() %>% setView(lng = -71.1, lat = 42.4, zoom = 12) %>% addCircleMarkers(lng = -71.1, lat = 42.4, popup = p_popup2) %>% 
  addCircleMarkers(lng = -71.092003, lat = 42.360001, popup = p_popup, color = "red") %>% 
  addPolygons(stroke = TRUE, 
    fillColor = "yellow", 
    fillOpacity = 0.8, smoothFactor = 0.5)
```

So the central campus of MIT is not near the most used stations in 2019 and 2020, but it makes we think that plotting the different higher learning institutions located in Boston might yield interesting results seeing as many of the stations are clustered around this area.

Load colleges and universities
```{r}
uni <- st_read("data/Colleges_and_Universities/Colleges_and_Universities.shp")

# reproject to get it on the map
projected_uni <- st_transform(uni, 4326)

projected_uni <- projected_uni[!(projected_uni$Longitude == 0.0000|projected_uni$Latitude == 0.0000), ]
```

Plot the colleges and universities on a map together with the start stations from 2019 and 2020
```{r}
p7_popup <- paste0("<strong>Institution: </strong>", projected_uni$Name)

leaflet() %>% addTiles() %>% 
  addCircleMarkers(lng = projected_uni$Longitude, lat = projected_uni$Latitude, color = "red", popup = p7_popup) %>% 
  addCircleMarkers(lng = unique_start$start_long, lat = unique_start$start_lat) %>% setView(lng = -71.1, lat = 42.35, zoom = 11.5)
```

```{r}
leaflet() %>% addTiles() %>% 
  addCircleMarkers(lng = projected_uni$Longitude, lat = projected_uni$Latitude, color = "red", popup = p7_popup) %>% 
  addCircleMarkers(lng = unique_start_2020$start_long, lat = unique_start_2020$start_lat) %>% setView(lng = -71.1, lat = 42.35, zoom = 11.5)
```

It does in fact seem that many of the start station points are centered around the location of the colleges and universities. 

Let's make the colleges and universities into a polygon and plot it again 
```{r}
# remove NAs if there is any
points_uni <- projected_uni %>% 
  filter(! is.na(Longitude)) %>% 
  filter(! is.na(Latitude))
# transform points into sf object
points_uni_sf <- st_as_sf(points_uni, coords = c("Longitude", "Latitude"), crs = 4326)
# transform its crs 
points_uni_3035 <- st_transform(points_uni_sf, crs = 3035)
# create convex hull
points_uni_ch <- st_convex_hull(st_union(points_uni_3035))
# plot it
plot(points_uni_ch)
# give it projected crs again
points_uni_ch_3035 <- st_transform(points_uni_ch, crs = 4326)
```

Let's plot the colleges and universities polygon together the with 2019 start stations
```{r}
leaflet(points_uni_ch_3035) %>% addTiles() %>% 
  addPolygons(color = "yellow") %>% 
  addCircleMarkers(lng = unique_start$start_long, lat = unique_start$start_lat) %>% setView(lng = -71.1, lat = 42.35, zoom = 11.5)
```

```{r}
leaflet(points_uni_ch_3035) %>% addTiles() %>% 
  addPolygons(color = "yellow") %>% 
  addCircleMarkers(lng = unique_start_2020$start_long, lat = unique_start_2020$start_lat) %>% setView(lng = -71.1, lat = 42.35, zoom = 11.5)
```

So indeed, I does seem that the colleges and institutions take up a fairly large part of the space the points occupy. Let's confirm this be getting the intersection between the points-polygon and the colleges and universities-polygon
```{r}
# get the intersections
uni_points_intersection <- st_intersection(st_union(points_ch, points_uni_ch))

# create buffer feature of the neighborhoods
p_n_buff_uni <- st_union(uni_points_intersection)
```

Plot the objects together
```{r}
plot(points_ch)
plot(uni_points_intersection, add = TRUE)
plot(points_uni_ch, border = "red", add = TRUE)
```

Compare with the neighborhoods and points intersection
```{r}
plot(points_ch)
plot(points_neighborhoods_intersection, border='red', lwd=2, add = TRUE)
plot(p_n_buff, add = TRUE)
```

Indeed, the intersection of the colleges and universities occupy around the same amount of space as the neighborhoods. However, they also occupy the same space within the points-polygon, and I therefore find the intersection between the neighborhoods and the colleges and universities
```{r}
neighborhoods_uni_intersection <- st_intersection(points_uni_ch, neighborhoods_3035)

plot(points_uni_ch)
plot(neighborhoods_uni_intersection, border="red", lwd=2, add = TRUE)
plot(p_n_buff, add = TRUE)
```

So, the neighborhoods and the learning institutions occupy much of the same space. Therefore, it is not possible to reliably confirm that the the users of the bikes are primarily seeking out the learning institutions. However, the overlay of the institutions on the points, did capture a real pattern of use just like the neighborhoods did.  

Let's look at the map with the most used start/end station again
```{r}
p_popup = paste0("<strong>Start station: </strong>", "MIT")
p_popup2 = paste0("<strong>institution: </strong>", "Central Square at Mass Ave / Essex St")

# with slight changes to the view setting
leaflet(projected_neighborhoods) %>% addTiles() %>% setView(lng = -71.1, lat = 42.4, zoom = 15.5) %>% addCircleMarkers(lng = -71.1, lat = 42.4, popup = p_popup2) %>% 
  addPolygons(stroke = TRUE, 
    fillColor = "yellow", 
    fillOpacity = 0.8, smoothFactor = 0.5)
```


Here I overlay data from public and non-public schools
```{r}
public <- st_read("data/Public_Schools/Public_Schools.shp")
public <- st_transform(public, 4326)
public <- st_as_sf(public, crs = 4326)
public <- st_convex_hull(public$geometry)
# extract coordinates
public_coordinates <- st_coordinates(public)
class(public_coordinates)
# transform to data frame
public_df <- public_coordinates %>% 
  as_tibble()


# I do the same for the non-public schools
non_public <- st_read("data/Non_Public_Schools/Non_Public_Schools.shp")
non_public <- st_transform(non_public, 4326)
non_public <- st_as_sf(non_public, crs = 4326)
non_public <- st_convex_hull(non_public$geometry)
# extract coordinates
non_public_coordinates <- st_coordinates(non_public)
class(non_public_coordinates)
# transform to data frame
non_public_df <- non_public_coordinates %>% 
  as_tibble()

non_public_df <- non_public_coordinates %>% as_tibble()

# help if they need to be sf objects again: https://stackoverflow.com/questions/44214487/create-sf-object-from-two-column-matrix
```

Now we can plot the schools at points on the map alongside the start stations
```{r}
p_popup <- paste0("Public")
p_popup2 <- paste0("Non-public")

leaflet() %>% addTiles() %>% 
  addCircleMarkers(lng = unique_start$start_long, lat = unique_start$start_lat) %>% 
  addCircleMarkers(lng = public_df$X, lat = public_df$Y, color = "red", popup = p_popup) %>% 
  addCircleMarkers(lng = non_public_df$X, lat = non_public_df$Y, color = "yellow", popup = p_popup2) %>% setView(lng = -71.1, lat = 42.35, zoom = 11.5)
```

This plot seems to reflect a usage pattern dominat in the lower part of the city. There are many overlaps of the points. Let's transform the schools into a polygon and plot again. I do this by finding the collected shared space between the points
```{r}
non_public_sf <-  st_as_sf(non_public_df, coords = c("X", "Y"), crs = 4326)
class(non_public_sf)
non_public_sf

non_public_sf <- st_transform(non_public_sf, 3035)
non_public_sf

non_public_ch <- st_convex_hull(st_union(non_public_sf))
plot(non_public_ch)

plot(non_public_ch)

public_sf <- non_public_coordinates %>% 
  as_tibble() %>% 
  sf::st_as_sf(coords=c(1,2), crs = 4326)
class(public_sf)

public_sf <- st_transform(public_sf, 3035)

public_ch <- st_convex_hull(st_union(public_sf))
plot(public_ch)

schools <- st_convex_hull(st_union(non_public_ch, public_ch))
plot(schools)
```

Plot the schools with the stations points 
```{r}
plot(points_ch)
plot(schools, border = "yellow", lwd= 2, add = TRUE)
```

So the schools also take a around the same space that the neighborhoods did and the colleges and universities did 

### Expanding the search 
Instead of focusing on the most used stations, let's find the top 40 (10%) most used stations, to see if there is a pattern there.

Top 36 stations in 2019
```{r}
unique_start %>% select(start_station_name) %>% unique() %>%  count() # 361

# get the station names
stations_2019 <- table(data_2019$start_station_name)
# convert to tibble
stations_2019_df <- as.data.frame(stations_2019) %>% as_tibble()
# get the indices in ascending order of frequency
order(stations_2019_df$Freq)
# select the top 36
top36_2019 <- stations_2019_df[c(24, 282, 256, 207, 60, 53, 210, 244, 284, 62, 238, 205, 331, 353, 48, 218, 108, 120, 80, 89, 36, 83, 30, 252, 61, 97, 230, 228, 173, 241, 200, 22, 298, 229, 84, 227),]
# rename station name column
top36_2019 <- rename(top36_2019,
                           "start_station_name" = "Var1")
# merge data frame with longitude and latitude coordinates from data_2019
top36_2019 <- left_join(top36_2019, unique_start, by = "start_station_name")

# somehow I got 41 stations from this, but let's plot them anyway 
leaflet() %>% addTiles() %>% 
  addCircleMarkers(lng = top36_2019$start_long, lat = top36_2019$start_lat)
```

Top 38 stations in 2020
```{r}
unique_start_2020 %>% select(start_station_name) %>% unique() %>% count() # 385

stations_2020 <- table(data_2020$start_station_name)

stations_2020_df <- as.data.frame(stations_2020) %>% as_tibble()

order(stations_2020_df$Freq)

top_38_2020 <- stations_2020_df[c(90, 96, 243, 103, 20, 65, 127, 246, 38, 182, 247, 274, 248, 258, 254, 222, 223, 89, 85, 219, 210, 261, 112, 373, 301, 214, 297, 123, 102, 266, 233, 64, 318, 270, 190, 351, 132, 22, 356, 295),]

top_38_2020 <- rename(top_38_2020,
                      "start_station_name" = Var1)

top_38_2020 <- left_join(top_38_2020, unique_start_2020, by = "start_station_name")

# again, somehow I got 42 rows, but let's plot them
leaflet() %>% addTiles() %>% 
  addCircleMarkers(lng = top_38_2020$start_long, lat = top_38_2020$start_lat)

# draw a polygon out of the points and plot
```

It seems that the top stations of 2019 and 2020 overlap a lot, so let's find their intersections

Find intersection between the two top stations-polygon
```{r}
top_2019 <- st_as_sf(top36_2019, coords = c("start_long", "start_lat"), crs = 4326)
top_2019 <- st_transform(top_2019, crs = 3035)
top_2019_ch <- st_convex_hull(st_union(top_2019$geometry))
plot(top_2019_ch)

top_2020 <- st_as_sf(top_38_2020, coords = c("start_long", "start_lat"), crs = 4326)
top_2020 <- st_transform(top_2020, crs = 3035)
top_2020_ch <- st_convex_hull(st_union(top_2020$geometry))
plot(top_2020_ch)

top_stations <- st_intersection(st_union(top_2019_ch, top_2020_ch))

plot(top_stations, border = "yellow", lwd=2)
plot(top_2019_ch, border="red", lwd=2, add = TRUE)
plot(top_2020_ch, lwd=2, add = TRUE)
```

Let's see how the top stations overlap with the different polygons we have created
First, the neighborhoods
```{r}
plot(top_stations)
plot(p_n_buff, border = "red", lwd=2, add = TRUE)
```


## Looking at how the patterns vary over time
I need to select specific months and plot their points. I'll look at June or July for tourist season. And then I'll also look at the coldest month, January, for a comparison.

I first explore the number of data points in each month 
```{r}
cleaned_2019 %>% filter(month == 6) # June has 274,083 data points
cleaned_2019 %>% filter(month == 7) # July has 317,028 data points 
# August and September has the most data points so that is also worth exploring

cleaned_2019 %>% filter(month == 1) # January has the least, 69,872
```

Seeing as I know that it's mainly locals using the bikes, I'll stick to looking at either June or July as that seems to be peak tourist season, and I therefore expect to see the biggest differences in patterns in these months. 

Let's look at July!
```{r}
July_2019 <- cleaned_2019 %>% filter(month == 7)
July_2019 <- July_2019 %>% select(c(start_long, start_lat, start_station_name)) %>% unique()
# Remove outlier if it is there
July_2019 <- July_2019[!(July_2019$start_long == 0.0000|July_2019$start_lat == 0.0000), ]

# another outlier
July_2019 <- July_2019 %>% filter(start_station_name != "BCBS Hingham")

p_popup <- paste0("<strong>Neighborhood: </strong>", projected_neighborhoods$Name) 

p3_popup <- paste0("<strong>Start station: </strong>", July_2019$start_station_name)

leaflet(projected_neighborhoods) %>% 
  addPolygons(
    stroke = TRUE, 
    fillColor = "yellow", 
    fillOpacity = 0.8, smoothFactor = 0.5, # to make it look nicer
    popup = p_popup) %>% # add popup 
  addTiles() %>%
  setView(lng = -71.077083, lat = 42.341145, zoom = 11.5) %>% 
  addCircleMarkers(lng = July_2019$start_long,
                   lat = July_2019$start_lat,
                   popup = p3_popup)
```

Let's look at January!
```{r}
January_2019 <- cleaned_2019 %>% filter(month == 1)
January_2019 <- January_2019 %>% select(c(start_long, start_lat, start_station_name)) %>% unique()
# Remove outlier if it is there
January_2019 <- January_2019[!(January_2019$start_long == 0.0000|January_2019$start_lat == 0.0000), ]

p_popup <- paste0("<strong>Neighborhood: </strong>", projected_neighborhoods$Name) 

p4_popup <- paste0("<strong>Start station: </strong>", January_2019$start_station_name)

leaflet(projected_neighborhoods) %>% 
  addPolygons(
    stroke = TRUE, 
    fillColor = "yellow", 
    fillOpacity = 0.8, smoothFactor = 0.5, # to make it look nicer
    popup = p_popup) %>% # add popup 
  addTiles() %>%
  setView(lng = -71.077083, lat = 42.341145, zoom = 11.5) %>% 
  addCircleMarkers(lng = January_2019$start_long,
                   lat = January_2019$start_lat,
                   popup = p4_popup)
```

We can clearly see that there are fewer points in January, but other than that, it's difficult to say anything from this map. So I'll have to think about that. Now I'll find the intersection between the neighborhoods and the points in July and January 

First, July!
```{r}
points_July <- July_2019 %>% 
  filter(! is.na(start_long)) %>% 
  filter(! is.na(start_lat))

points_July_sf <- st_as_sf(points_July, coords = c("start_long", "start_lat"), crs = 4326)

points_July_3035 <- st_transform(points_July_sf, crs = 3035)
# create convex hull
points_July_ch <- st_convex_hull(st_union(points_July_3035))
```

Get the intersections
```{r}
# get the intersections
points_neighborhoods_intersection <- st_intersection(points_July_ch, st_geometry(neighborhoods_3035))

# create buffer feature of the neighborhoods
p_n_buff_July <- st_union(points_neighborhoods_intersection)
```

Plot the objects together
```{r}
plot(points_July_ch)
plot(points_neighborhoods_intersection, border='red', lwd=2, add = TRUE)
plot(p_n_buff_July, add = TRUE)
```

Again, looks very much like the general one I've created

Now, January!
```{r}
points_January <- January_2019 %>% 
  filter(! is.na(start_long)) %>% 
  filter(! is.na(start_lat))

points_January_sf <- st_as_sf(points_January, coords = c("start_long", "start_lat"), crs = 4326)

points_January_3035 <- st_transform(points_January_sf, crs = 3035)
# create convex hull
points_January_ch <- st_convex_hull(st_union(points_January_3035))
```

Get the intersections
```{r}
# get the intersections
points_neighborhoods_intersection <- st_intersection(points_January_ch, st_geometry(neighborhoods_3035))

# create buffer feature of the neighborhoods
p_n_buff_January <- st_union(points_neighborhoods_intersection)
```

Plot the objects together
```{r}
plot(points_January_ch)
plot(points_neighborhoods_intersection, border='red', lwd=2, add = TRUE)
plot(p_n_buff_January, add = TRUE)
```

The points are much more centered around the central part of Boston in January. In fact, almost the entire area the points cover, is within the neighborhoods, which is very different what what we have seen so far. *this is the first finding that is different and something to mention in the report*

To sum up so far. The end and start station maps look very similar. There is a clear different between the July map and the January map, where it seems that the points in January are more centralized and they are more dispersed in July. This is further supported using the st_intersection function, where much more of the polygon, created from the January points, are covered by the neighborhoods. Therefore, the users of the bikes do not travel as far outside of the city in January than they do in July.

```{r}
January_2020 <- cleaned_2020 %>% filter(month == 1)
January_2020 <- January_2020 %>% select(c(start_long, start_lat, start_station_name)) %>% unique()
January_2020 <- January_2020[!(January_2020$start_long == 0.0000|January_2020$start_lat == 0.0000),]

p_popup <- paste0("<strong>Neighborhood: </strong>", projected_neighborhoods$Name) 
p1_popup <- paste0("<strong>Station: </strong>", January_2020$start_station_name)

leaflet(projected_neighborhoods) %>% addTiles() %>% 
  addPolygons(stroke = TRUE, 
    fillColor = "yellow", 
    fillOpacity = 0.8, smoothFactor = 0.5, # to make it look nicer
    popup = p_popup) %>% 
  addCircleMarkers(lng = January_2020$start_long, lat = January_2020$start_lat, popup = p1_popup) %>% setView(lng = -71.077083, lat = 42.341145, zoom = 11.5)
```

```{r}
July_2020 <- cleaned_2020 %>% filter(month == 7)
July_2020 <- July_2020 %>% select(c(start_long, start_lat, start_station_name)) %>% unique()
July_2020 <- July_2020[!(July_2020$start_long == 0.0000|July_2020$start_lat == 0.0000),]

July_2020 <-  July_2020 %>% filter(start_station_name != "BCBS Hingham")

p_popup <- paste0("<strong>Neighborhood: </strong>", projected_neighborhoods$Name) 
p1_popup <- paste0("<strong>Station: </strong>", July_2020$start_station_name)

leaflet(projected_neighborhoods) %>% addTiles() %>% 
  addPolygons(stroke = TRUE, 
    fillColor = "yellow", 
    fillOpacity = 0.8, smoothFactor = 0.5, # to make it look nicer
    popup = p_popup) %>% 
  addCircleMarkers(lng = July_2020$start_long, lat = July_2020$start_lat, popup = p1_popup) %>% setView(lng = -71.077083, lat = 42.341145, zoom = 11.5)
```

```{r}
points_July_2020 <- July_2020 %>% 
  filter(! is.na(start_long)) %>% 
  filter(! is.na(start_lat))

points_July_sf_2020 <- st_as_sf(points_July_2020, coords = c("start_long", "start_lat"), crs = 4326)

points_July_3035_2020 <- st_transform(points_July_sf_2020, crs = 3035)
# create convex hull
points_July_ch_2020 <- st_convex_hull(st_union(points_July_3035_2020))
```

Get the intersections
```{r}
# get the intersections
points_neighborhoods_intersection_July_2020 <- st_intersection(points_July_ch_2020, st_geometry(neighborhoods_3035))

# create buffer feature of the neighborhoods
p_n_buff_July_2020 <- st_union(points_neighborhoods_intersection_July_2020)
```

Plot the objects together
```{r}
plot(points_July_ch_2020)
plot(points_neighborhoods_intersection_July_2020, border='red', lwd=2, add = TRUE)
plot(p_n_buff_July_2020, add = TRUE)
```

```{r}
points_January_2020 <- January_2020 %>% 
  filter(! is.na(start_long)) %>% 
  filter(! is.na(start_lat))

points_January_sf_2020 <- st_as_sf(points_January_2020, coords = c("start_long", "start_lat"), crs = 4326)

points_January_3035_2020 <- st_transform(points_January_sf_2020, crs = 3035)
# create convex hull
points_January_ch_2020 <- st_convex_hull(st_union(points_January_3035_2020))
```

Get the intersections
```{r}
# get the intersections
points_neighborhoods_intersection_January_2020 <- st_intersection(points_January_ch_2020, st_geometry(neighborhoods_3035))

# create buffer feature of the neighborhoods
p_n_buff_January_2020 <- st_union(points_neighborhoods_intersection_January_2020)
```

Plot the objects together
```{r}
plot(points_January_ch_2020)
plot(points_neighborhoods_intersection_January_2020, border='red', lwd=2, add = TRUE)
plot(p_n_buff_January_2020, add = TRUE)
```


Let's see how the point patterns look at the peak of lockdown in Boston in 2020. From wikipedia, I can gather that the lockdown started from the end of March 2020, and the code below shows that the least data points are found in April
```{r}
data_2020 %>% filter(month == 4) # 46,793 
# compared with 2019's slowest month, January with 69,872 data points 
```

Let's plot the April 2020 data 
```{r}
April_2020 <- cleaned_2020 %>% filter(month == 4)
April_2020 <- April_2020 %>% select(c(start_long, start_lat, start_station_name)) %>% unique()
# Remove outlier if it is there
April_2020 <- April_2020[!(April_2020$start_long == 0.0000|April_2020$start_lat == 0.0000), ]

p_popup <- paste0("<strong>Neighborhood: </strong>", projected_neighborhoods$Name) 

p6_popup <- paste0("<strong>Start station: </strong>", April_2020$start_station_name)

leaflet(projected_neighborhoods) %>% 
  addPolygons(
    stroke = TRUE, 
    fillColor = "yellow", 
    fillOpacity = 0.8, smoothFactor = 0.5, # to make it look nicer
    popup = p_popup) %>% # add popup 
  addTiles() %>%
  setView(lng = -71.077083, lat = 42.341145, zoom = 11.5) %>% 
  addCircleMarkers(lng = April_2020$start_long,
                   lat = April_2020$start_lat,
                   popup = p4_popup)

data_2020 %>% select(c(month, start_station_name)) %>% filter(month == 4) %>% select(start_station_name) %>% unique() # 329 unique stations names in April 2020, which means that there are fewer unique stations than in January 2019, but probably not significantly so

# let's compare the April 2020 map with the January 2019 map
p4_popup <- paste0("<strong>Start station: </strong>", January_2019$start_station_name)

leaflet(projected_neighborhoods) %>% 
  addPolygons(
    stroke = TRUE, 
    fillColor = "yellow", 
    fillOpacity = 0.8, smoothFactor = 0.5, # to make it look nicer
    popup = p_popup) %>% # add popup 
  addTiles() %>%
  setView(lng = -71.077083, lat = 42.341145, zoom = 11.5) %>% 
  addCircleMarkers(lng = January_2019$start_long,
                   lat = January_2019$start_lat,
                   popup = p4_popup)
```

```{r}
points_April_2020 <- April_2020 %>% 
  filter(! is.na(start_long)) %>% 
  filter(! is.na(start_lat))

points_April_sf_2020 <- st_as_sf(points_April_2020, coords = c("start_long", "start_lat"), crs = 4326)

points_April_3035_2020 <- st_transform(points_April_sf_2020, crs = 3035)
# create convex hull
points_April_ch_2020 <- st_convex_hull(st_union(points_April_3035_2020))
```

Get the intersections
```{r}
# get the intersections
points_neighborhoods_intersection_April_2020 <- st_intersection(points_April_ch_2020, st_geometry(neighborhoods_3035))

# create buffer feature of the neighborhoods
p_n_buff_April_2020 <- st_union(points_neighborhoods_intersection_April_2020)
```

Plot the objects together
```{r}
plot(points_April_ch_2020)
plot(points_neighborhoods_intersection_April_2020, border='red', lwd=2, add = TRUE)
plot(p_n_buff_April_2020, add = TRUE)
```


The points are much more centered towards to central part of Boston in January 2019 than in April 2020, where there are many more points in the southern part of the city.

*compare intersection of April 2020 and January 2020*

## Routes
```{r}
unique_end %>% select(end_station_name) %>% unique() %>%  count() # 360

# get the station names
stations_2019 <- table(data_2019$end_station_name)
# convert to tibble
stations_2019_df <- as.data.frame(stations_2019) %>% as_tibble()
# get the indices in ascending order of frequency
order(stations_2019_df$Freq)
# select the top 36
top36_2019_end <- stations_2019_df[c(207, 24, 130, 284, 331, 60,  53, 244, 209,  62, 210, 238, 205, 218,  48, 354, 108,  80,  89,  36, 252, 120,  30,  83,  61,  97, 230, 200, 228, 173, 298, 229, 241,  22,  84, 227),]
# rename station name column
top36_2019_end <- rename(top36_2019_end,
                           "end_station_name" = "Var1")
# merge data frame with longitude and latitude coordinates from data_2019
top36_2019_end <- left_join(top36_2019_end, unique_end, by = "end_station_name")

coords_start_2019 <- top36_2019 %>% st_as_sf(coords = c("start_long", "start_lat"), crs = 4326)

coords_end_2019 <- top36_2019_end %>% st_as_sf(coords = c("end_long", "end_lat"), crs = 4326)

lines <- st_sfc(mapply(function(a,b){
  st_cast(st_union(a,b),"LINESTRING")}, 
  coords_start_2019$geometry, coords_end_2019$geometry, SIMPLIFY=FALSE))
# https://stackoverflow.com/questions/65498300/how-to-efficiently-create-linestrings-from-points
```


